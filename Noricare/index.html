<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Service</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 基础变量设定 --- */
        :root {
            --primary: #0056b3;       
            --primary-dark: #003d82;
            --accent: #e3f2fd;        
            --bg-color: #f8f9fa;      
            --surface: #ffffff;       
            --text-main: #2c3e50;     
            --text-sub: #546e7a;
            --border: #cccccc;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0,0,0,0.12);
            
            --sidebar-text: #ffffff;
            --sidebar-label: #e3f2fd; 
        }

        /* --- 全局样式 --- */
        body {
            font-size: 16px;
            font-family: 'Roboto', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
        }

        /* --- 主布局容器 --- */
        .main-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            width: 90%;
            max-width: 1280px;
            height: 85vh;
            min-height: 600px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* --- 左侧边栏 (Sidebar) --- */
        .sidebar {
            background: linear-gradient(145deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--sidebar-text);
            padding: 30px 25px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(0,0,0,0.1);
        }

        /* Logo 区域 */
        .brand {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .brand img {
            max-width: 90%;
            height: auto;
            object-fit: contain;
            background: #ffffff;
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        /* 摘要面板 */
        .summary-panel {
            flex-grow: 1; 
        }

        .summary-title {
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
            font-weight: 800;
        }

        .summary-item {
            margin-bottom: 20px;
        }
        
        .summary-item label {
            display: block;
            font-size: 0.95rem;
            color: var(--sidebar-label);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .summary-item span {
            display: block;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            min-height: 24px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* 语言按钮 */
        .lang-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.6);
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
            align-self: flex-start;
            font-weight: 700;
            margin-top: auto; 
        }
        .lang-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- 右侧内容区 --- */
        .content-area {
            padding: 40px 50px;
            overflow-y: auto;
            position: relative;
        }

        /* 步骤条 */
        .stepper {
            display: flex;
            margin-bottom: 30px;
            gap: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        .step-dot {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #888;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            border: 2px solid transparent;
        }
        .step-dot.active { 
            background: var(--primary); 
            color: white; 
            transform: scale(1.1); 
            box-shadow: 0 0 0 3px var(--accent);
        }
        .step-dot.done { background: #4caf50; color: white; }

        /* 标题与文字 */
        h2 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
            margin-top: 0;
            font-weight: 800;
        }
        p.subtitle {
            font-size: 1.1rem;
            color: var(--text-sub);
            margin-bottom: 30px;
            line-height: 1.4;
            font-weight: 500;
        }

        /* 表单控件 */
        .form-row {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }
        input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1.2rem;
            background: #f9f9f9;
            box-sizing: border-box;
            transition: all 0.3s;
            color: var(--text-main);
            font-weight: 600;
        }
        input::placeholder { color: #aaa; }
        input:focus {
            border-color: var(--primary);
            outline: none;
            background: white;
            box-shadow: 0 0 0 4px rgba(0,86,179,0.15);
        }

        /* --- 地区选择卡片 --- */
        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .region-card {
            position: relative;
            height: 180px;
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .region-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .region-card.selected {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,86,179,0.25);
        }
        /* 选中遮罩 */
        .region-card.selected::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 86, 179, 0.5); 
            z-index: 1;
            pointer-events: none;
        }
        /* 选中对勾 */
        .region-card.selected::before {
            content: '✓';
            position: absolute;
            top: 10px; right: 10px;
            background: white;
            color: var(--primary);
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900;
            z-index: 3;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .region-card img {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }
        .region-card:hover img {
            transform: scale(1.1);
        }

        .region-text-overlay {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px 15px;
            box-sizing: border-box;
            z-index: 2;
        }
        .region-name {
            color: white;
            font-size: 1.4rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            display: block;
        }

        /* --- 地图预览区域 --- */
        .map-preview {
            margin-top: 30px;
            border-radius: 16px;
            border: 2px solid var(--border);
            background: #ffffff;
            display: none; 
            padding: 25px;
            box-shadow: 0 20px 40px rgba(15, 22, 37, 0.1);
        }
        .map-preview h4 {
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .map-status {
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--text-sub);
        }
        #selectedDistrict {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.2rem;
        }

        /* --- 地图交互样式 (修正版) --- */
        #seoulMap {
            width: 100%;
            height: 400px; /* 固定高度，不再使用不稳定的 max-height */
            border-radius: 12px;
            background: #f4f7f9;
            border: 1px solid #e0e0e0;
            /* 使用 Flex 布局确保 SVG 居中显示 */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .district-path {
            stroke: #ffffff;
            stroke-width: 1.5;
            cursor: pointer;
            transition: all 0.2s;
        }
        .district-path:hover {
            fill: #d0d9e1 !important; 
            filter: brightness(0.95);
        }
        .district-path.active {
            fill: #d32f2f !important; 
            stroke: #ffffff !important;
            stroke-width: 3;
            filter: drop-shadow(0 3px 6px rgba(211, 47, 47, 0.3));
            transform: scale(1.005);
            z-index: 10;
        }
        .district-label {
            font-size: 12px;
            font-weight: 700;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none; 
            font-family: 'Roboto', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* --- PT 列表 --- */
        .pt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }
        .pt-card {
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .pt-card:hover {
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
            transform: translateY(-5px);
        }
        .pt-img {
            width: 100px; height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid var(--accent);
        }
        .pt-name { font-size: 1.3rem; font-weight: 700; color: var(--text-main); margin: 0 0 5px 0;}
        .pt-spec { color: var(--primary); margin: 0 0 10px 0; font-size: 1rem; font-weight: 600; }
        .pt-gender { 
            display: inline-block; 
            padding: 5px 15px; 
            background: #f0f2f5; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            color: #666;
            font-weight: 600;
        }

        /* --- 按钮区域 --- */
        .action-bar {
            margin-top: 50px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
        }
        button { letter-spacing: 0.5px; }
        .btn-back {
            background: #ffffff;
            color: var(--text-main);
            border: 3px solid var(--border);
            padding: 12px 30px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: 0.3s;
            margin-right: auto;
        }
        .btn-back:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--accent);
        }
        .btn-next {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0,86,179,0.25);
            transition: all 0.3s;
        }
        .btn-next:hover { 
            background-color: var(--primary-dark); 
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,86,179,0.35);
        }

        /* 页面切换动画 */
        .section { display: none; animation: fadeSlide 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .section.active { display: block; }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 成功页面 */
        .success-box { text-align: center; padding-top: 40px; }
        .checkmark {
            width: 100px; height: 100px; background: #2e7d32; border-radius: 50%; color: white;
            font-size: 60px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(46, 125, 50, 0.3);
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <aside class="sidebar">
        <div>
            <div class="brand">
                <img src="https://cdn.imweb.me/thumbnail/20250827/00af92211094e.png" alt="Logo">
            </div>
            
            <div class="summary-panel">
                <div class="summary-title" data-key="summary_title">BOOKING SUMMARY</div>
                
                <div class="summary-item">
                    <label data-key="label_name">Name</label>
                    <span id="sumName">-</span>
                </div>
                
                <div class="summary-item">
                    <label data-key="label_age">Age</label>
                    <span id="sumAge">-</span>
                </div>
                
                <div class="summary-item">
                    <label data-key="summary_loc">Region</label>
                    <span id="sumRegion">-</span>
                </div>
                
                <div class="summary-item">
                    <label data-key="summary_pt">Selected PT</label>
                    <span id="sumPT">-</span>
                </div>
            </div>
        </div>
        
        <button class="lang-btn" onclick="toggleLanguage()">한 / En</button>
    </aside>

    <main class="content-area">
        
        <div class="stepper">
            <div class="step-dot active" id="dot1">1</div>
            <div class="step-dot" id="dot2">2</div>
            <div class="step-dot" id="dot3">3</div>
            <div class="step-dot" id="dot4">4</div>
        </div>

        <div id="sec1" class="section active">
            <h2 data-key="step1_title">Welcome</h2>
            <p class="subtitle" data-key="step1_sub">Please enter your information.</p>
            
            <div class="form-row">
                <div class="form-group">
                    <label data-key="label_name">Full Name</label>
                    <input type="text" id="inpName" placeholder="Ex: Kim Min-su" oninput="liveUpdate()">
                </div>
                <div class="form-group">
                    <label data-key="label_age">Age</label>
                    <input type="number" id="inpAge" placeholder="Ex: 68" oninput="liveUpdate()">
                </div>
            </div>
            
            <div class="action-bar">
                <button class="btn-next" onclick="goNext(1)" data-key="btn_next">Continue &rarr;</button>
            </div>
        </div>

        <div id="sec2" class="section">
            <h2 data-key="step2_title">Select Region</h2>
            <p class="subtitle" data-key="step2_sub">Where do you need the service?</p>
            
            <div class="region-grid">
                <div class="region-card" onclick="pickRegion(this, 'Seoul')">
                    <img src="https://www.dynastykorea.com/wp-content/uploads/2020/11/N-Seoul-Tower-.webp" alt="Seoul">
                    <div class="region-text-overlay"><span class="region-name" data-key="city_seoul">Seoul</span></div>
                </div>
                <div class="region-card" onclick="pickRegion(this, 'Busan')">
                    <img src="https://visitbusan.net/uploadImgs/files/cntnts/20200206095453466_wufrotr" alt="Busan">
                    <div class="region-text-overlay"><span class="region-name" data-key="city_busan">Busan</span></div>
                </div>
                <div class="region-card" onclick="pickRegion(this, 'Daegu')">
                    <img src="https://i0.wp.com/mytravelation.com/wp-content/uploads/2023/11/83-Tower-Daegu.jpg?resize=723%2C483&ssl=1" alt="Daegu">
                    <div class="region-text-overlay"><span class="region-name" data-key="city_daegu">Daegu</span></div>
                </div>
                <div class="region-card" onclick="pickRegion(this, 'Gwangju')">
                    <img src="https://dynamic-media-cdn.tripadvisor.com/media/photo-o/1c/49/58/70/photo2jpg.jpg?w=500&h=500&s=1" alt="Gwangju">
                    <div class="region-text-overlay"><span class="region-name" data-key="city_gwangju">Gwangju</span></div>
                </div>
                <div class="region-card" onclick="pickRegion(this, 'Incheon')">
                    <img src="https://www.pcma.org/wp-content/uploads/2021/10/Songdo-Convensia-1.jpg" alt="Incheon">
                    <div class="region-text-overlay"><span class="region-name" data-key="city_incheon">Incheon</span></div>
                </div>
            </div>

            <div id="mapPreview" class="map-preview">
                <h4>Seoul map</h4>
                <div class="map-status">Selected district: <span id="selectedDistrict">None</span></div>
                <div id="seoulMap"></div>
            </div>

            <div class="action-bar">
                <button class="btn-back" onclick="goBack(1)" data-key="btn_back">← Back</button>
                <button class="btn-next" onclick="goNext(2)" data-key="btn_next">Continue &rarr;</button>
            </div>
        </div>

        <div id="sec3" class="section">
            <h2 data-key="step3_title">Choose Specialist</h2>
            <p class="subtitle" data-key="step3_sub">Select a Physical Therapist below.</p>
            <div class="pt-grid" id="ptGrid"></div>
            <div class="action-bar">
                <button class="btn-back" onclick="goBack(2)" data-key="btn_back">← Back</button>
            </div>
        </div>

        <div id="sec4" class="section">
            <h2 data-key="step4_title">Contact Info</h2>
            <p class="subtitle" data-key="step4_sub">Enter your mobile number to confirm.</p>
            <div class="form-group" style="max-width: 400px;">
                <label data-key="label_phone">Phone Number</label>
                <input type="tel" id="inpPhone" placeholder="010-xxxx-xxxx">
            </div>
            <div class="action-bar">
                <button class="btn-back" onclick="goBack(3)" data-key="btn_back">← Back</button>
                <button class="btn-next" onclick="goNext(4)" data-key="btn_confirm">Confirm Booking</button>
            </div>
        </div>

        <div id="sec5" class="section">
            <div class="success-box">
                <div class="checkmark">✓</div>
                <h2 data-key="step5_title">Booking Complete!</h2>
                <p data-key="success_msg" style="font-size: 1.4rem; margin-bottom: 40px;">We have sent a confirmation text to your phone.</p>
                <div class="action-bar" style="justify-content: center;">
                    <button class="btn-back" onclick="goBack(4)" data-key="btn_back" style="margin-right:0;">← Back</button>
                    <button class="btn-next" onclick="location.reload()" data-key="btn_home" style="margin-left: 20px;">Back to Home</button>
                </div>
            </div>
        </div>

    </main>
</div>

<script>
    // --- 数据与状态 ---
    let currentLang = 'en';
    let step = 1;
    let booking = { region: '', pt: '', district: '' };
    
    // 地图相关数据
    const SEOUL_SVG_SRC = 'https://upload.wikimedia.org/wikipedia/commons/a/ae/Seoul_districts.svg';
    const districtPalette = {
        'Gangseo-gu': '#8e99b3', 'Yangcheon-gu': '#5c6bc0', 'Yeongdeungpo-gu': '#b39ddb', 'Guro-gu': '#9fa8da',
        'Geumcheon-gu': '#b0bec5', 'Mapo-gu': '#81d4fa', 'Eunpyeong-gu': '#bcaaa4', 'Seodaemun-gu': '#a5d6a7',
        'Jongno-gu': '#ffe082', 'Jung-gu': '#ffcc80', 'Yongsan-gu': '#ffab91', 'Seongdong-gu': '#ce93d8',
        'Gwangjin-gu': '#f48fb1', 'Dongdaemun-gu': '#80cbc4', 'Seongbuk-gu': '#4db6ac', 'Gangbuk-gu': '#4dd0e1',
        'Dobong-gu': '#26c6da', 'Nowon-gu': '#00bcd4', 'Jungnang-gu': '#00acc1', 'Dongjak-gu': '#ff8a65',
        'Seocho-gu': '#a1887f', 'Gangnam-gu': '#90a4ae', 'Songpa-gu': '#78909c', 'Gangdong-gu': '#607d8b',
        'Gwanak-gu': '#ff7043'
    };
    const defaultDistrictColor = '#cfd8dc';
    const districtNames = {
        'Gangseo-gu': { en: 'Gangseo', ko: '강서구' }, 'Yangcheon-gu': { en: 'Yangcheon', ko: '양천구' },
        'Yeongdeungpo-gu': { en: 'Yeongdeungpo', ko: '영등포구' }, 'Guro-gu': { en: 'Guro', ko: '구로구' },
        'Geumcheon-gu': { en: 'Geumcheon', ko: '금천구' }, 'Mapo-gu': { en: 'Mapo', ko: '마포구' },
        'Eunpyeong-gu': { en: 'Eunpyeong', ko: '은평구' }, 'Seodaemun-gu': { en: 'Seodaemun', ko: '서대문구' },
        'Jongno-gu': { en: 'Jongno', ko: '종로구' }, 'Jung-gu': { en: 'Jung-gu', ko: '중구' },
        'Yongsan-gu': { en: 'Yongsan', ko: '용산구' }, 'Seongdong-gu': { en: 'Seongdong', ko: '성동구' },
        'Gwangjin-gu': { en: 'Gwangjin', ko: '광진구' }, 'Dongdaemun-gu': { en: 'Dongdaemun', ko: '동대문구' },
        'Seongbuk-gu': { en: 'Seongbuk', ko: '성북구' }, 'Gangbuk-gu': { en: 'Gangbuk', ko: '강북구' },
        'Dobong-gu': { en: 'Dobong', ko: '도봉구' }, 'Nowon-gu': { en: 'Nowon', ko: '노원구' },
        'Jungnang-gu': { en: 'Jungnang', ko: '중랑구' }, 'Dongjak-gu': { en: 'Dongjak', ko: '동작구' },
        'Seocho-gu': { en: 'Seocho', ko: '서초구' }, 'Gangnam-gu': { en: 'Gangnam', ko: '강남구' },
        'Songpa-gu': { en: 'Songpa', ko: '송파구' }, 'Gangdong-gu': { en: 'Gangdong', ko: '강동구' },
        'Gwanak-gu': { en: 'Gwanak', ko: '관악구' }
    };
    const districtLabels = {};
    const districtBaseColors = {};
    let seoulMapLoaded = false;
    let seoulMapLoading = false;
    let seoulSelectedPath = null;

    // 虚拟数据库
    const ptDB = [
        { id: 1, name: 'Dr. Park Ji-min', region: 'Seoul', gender: 'F', genderKO:'여', spec: 'Rehab', img: 'https://randomuser.me/api/portraits/women/44.jpg' },
        { id: 2, name: 'Dr. Lee Jun-ho', region: 'Seoul', gender: 'M', genderKO:'남', spec: 'Ortho', img: 'https://randomuser.me/api/portraits/men/32.jpg' },
        { id: 3, name: 'Dr. Kim Soo-jin', region: 'Busan', gender: 'F', genderKO:'여', spec: 'Geriatric', img: 'https://randomuser.me/api/portraits/women/68.jpg' },
        { id: 4, name: 'Dr. Choi Min', region: 'Busan', gender: 'M', genderKO:'남', spec: 'Sports', img: 'https://randomuser.me/api/portraits/men/22.jpg' },
        { id: 5, name: 'Dr. Han Ye-seul', region: 'Daegu', gender: 'F', genderKO:'여', spec: 'Neuro', img: 'https://randomuser.me/api/portraits/women/90.jpg' },
        { id: 6, name: 'Dr. Jung Woo', region: 'Gwangju', gender: 'M', genderKO:'남', spec: 'General', img: 'https://randomuser.me/api/portraits/men/64.jpg' },
        { id: 7, name: 'Dr. Song', region: 'Incheon', gender: 'M', genderKO:'남', spec: 'Muscle', img: 'https://randomuser.me/api/portraits/men/85.jpg' }
    ];

    // 语言包
    const txt = {
        en: {
            summary_title: "BOOKING SUMMARY", label_name: "Name", label_age: "Age", summary_loc: "Region", summary_pt: "Selected PT",
            step1_title: "Welcome", step1_sub: "Please enter your information.", btn_next: "Continue →",
            step2_title: "Select Region", step2_sub: "Where do you need the service?",
            step3_title: "Choose Specialist", step3_sub: "Select a Physical Therapist below.",
            step4_title: "Contact Info", step4_sub: "Enter your mobile number to confirm.", label_phone: "Phone Number", btn_confirm: "Confirm Booking",
            step5_title: "Booking Complete!", success_msg: "We have sent a confirmation text to your phone.", btn_home: "Back to Home",
            city_seoul: "Seoul", city_busan: "Busan", city_daegu: "Daegu", city_gwangju: "Gwangju", city_incheon: "Incheon",
            btn_back: "← Back"
        },
        ko: {
            summary_title: "예약 요약", label_name: "이름", label_age: "나이", summary_loc: "지역", summary_pt: "선택한 담당자",
            step1_title: "환영합니다", step1_sub: "기본 정보를 입력해 주세요.", btn_next: "계속하기 →",
            step2_title: "지역 선택", step2_sub: "서비스를 원하시는 지역을 선택하세요.",
            step3_title: "담당자 선택", step3_sub: "원하시는 물리치료사를 선택해 주세요.",
            step4_title: "연락처 확인", step4_sub: "예약 확정을 위해 번호를 입력하세요.", label_phone: "휴대전화 번호", btn_confirm: "예약 확정",
            step5_title: "예약 완료", success_msg: "확정 문자가 발송되었습니다.", btn_home: "홈으로 돌아가기",
            city_seoul: "서울", city_busan: "부산", city_daegu: "대구", city_gwangju: "광주", city_incheon: "인천",
            btn_back: "← 뒤로"
        }
    };

    // --- 核心交互逻辑 ---
    function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'ko' : 'en';
        updateDOM();
        if(step === 3) renderPTs(); 
    }

    function updateDOM() {
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if(txt[currentLang][key]) el.textContent = txt[currentLang][key];
        });
        updateRegionSummary();
        updateSelectedDistrictLabel();
    }

    function liveUpdate() {
        document.getElementById('sumName').textContent = document.getElementById('inpName').value || '-';
        document.getElementById('sumAge').textContent = document.getElementById('inpAge').value || '-';
    }

    function switchSection(n) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec' + n).classList.add('active');
        
        document.querySelectorAll('.step-dot').forEach((d, idx) => {
            d.classList.remove('active');
            if(idx + 1 === n) d.classList.add('active');
            if(idx + 1 < n) d.classList.add('done');
        });
        step = n;
    }

    function goNext(current) {
        if(current === 1) {
            if(!document.getElementById('inpName').value || !document.getElementById('inpAge').value) {
                alert(currentLang === 'en' ? 'Please fill in all fields' : '모든 항목을 입력해주세요');
                return;
            }
            switchSection(2);
        }
        if(current === 2) {
            if(!booking.region) {
                alert(currentLang === 'en' ? 'Please select a region' : '지역을 선택해주세요');
                return;
            }
            switchSection(3);
        }
        if(current === 4) {
            if(!document.getElementById('inpPhone').value) {
                alert(currentLang === 'en' ? 'Please enter phone number' : '번호를 입력해주세요');
                return;
            }
            switchSection(5);
        }
    }

    function goBack(target) {
        if(target < 1 || target > 5) return;
        switchSection(target);
    }

    // --- 地区与地图选择逻辑 ---
    function pickRegion(el, region) {
        document.querySelectorAll('.region-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        booking.region = region;
        
        // 重置具体区域选择状态
        booking.district = '';
        updateSelectedDistrictLabel();
        if (seoulSelectedPath) {
            seoulSelectedPath.classList.remove('active');
            seoulSelectedPath = null;
        }
        if (seoulMapLoaded) refreshDistrictLabelColors();

        const mapPreview = document.getElementById('mapPreview');
        if (mapPreview) {
            if (region === 'Seoul') {
                mapPreview.style.display = 'block';
                initSeoulMap();
            } else {
                mapPreview.style.display = 'none';
            }
        }

        renderPTs();
        updateRegionSummary();
    }

    function initSeoulMap() {
        if (seoulMapLoaded || seoulMapLoading) return;
        const container = document.getElementById('seoulMap');
        if (!container) return;
        seoulMapLoading = true;
        container.innerHTML = '<p style="padding:20px;">Loading map...</p>';
        
        fetch(SEOUL_SVG_SRC)
            .then(resp => {
                if (!resp.ok) throw new Error('Failed to fetch Seoul map');
                return resp.text();
            })
            .then(svgText => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, 'image/svg+xml');
                const svgEl = doc.documentElement;
                svgEl.removeAttribute('width');
                svgEl.removeAttribute('height');
                svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                
                // --- 修正关键：强制 SVG 填满容器高度，而不是只管宽度 ---
                svgEl.style.width = '100%';
                svgEl.style.height = '100%';
                // --------------------------------------------------
                
                svgEl.querySelectorAll('text').forEach(node => node.remove());
                const labelLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                labelLayer.setAttribute('class', 'district-label-layer');
                
                svgEl.querySelectorAll('path').forEach(path => {
                    path.classList.add('district-path');
                    const id = path.getAttribute('id') || '';
                    // 使用更柔和的颜色
                    const color = districtPalette[id] || defaultDistrictColor;
                    districtBaseColors[id] = color;
                    path.style.fill = color;
                    
                    // 绑定点击事件
                    path.addEventListener('click', function(e) {
                        e.stopPropagation(); // 防止冒泡
                        handleDistrictClick(this);
                    });
                    
                    const label = createDistrictLabel(path, color);
                    if (label) {
                        districtLabels[id] = label;
                        labelLayer.appendChild(label);
                    }
                });
                svgEl.appendChild(labelLayer);
                container.innerHTML = '';
                container.appendChild(svgEl);
                refreshDistrictLabelColors();
                seoulMapLoaded = true;
            })
            .catch(err => {
                container.innerHTML = '<p class="map-error" style="color:red;padding:20px;">Map loading failed. Please check connection.</p>';
                console.error(err);
            })
            .finally(() => {
                seoulMapLoading = false;
            });
    }

    function handleDistrictClick(path) {
        if (!path) return;
        // 移除之前的高亮
        if (seoulSelectedPath && seoulSelectedPath !== path) {
            seoulSelectedPath.classList.remove('active');
        }
        
        // 切换当前点击区域的高亮状态
        const isActive = path.classList.toggle('active');
        seoulSelectedPath = isActive ? path : null;
        
        const rawName = path.getAttribute('id') || 'District';
        booking.district = isActive ? rawName : '';
        
        updateSelectedDistrictLabel();
        refreshDistrictLabelColors(isActive ? rawName : '');
        updateRegionSummary();
    }

    function createDistrictLabel(path, color) {
        if (!path || typeof path.getBBox !== 'function') return null;
        try {
            const bbox = path.getBBox();
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.textContent = formatDistrictLabel(path.getAttribute('id'));
            label.setAttribute('x', bbox.x + bbox.width / 2);
            label.setAttribute('y', bbox.y + bbox.height / 2);
            label.setAttribute('class', 'district-label');
            label.setAttribute('dominant-baseline', 'middle');
            // 初始颜色
            label.setAttribute('fill', getLabelColor(color));
            return label;
        } catch(e) {
            console.warn('Could not create label for path', path);
            return null;
        }
    }

    function refreshDistrictLabelColors(activeId = '') {
        Object.keys(districtLabels).forEach(id => {
            const labelEl = districtLabels[id];
            if (!labelEl) return;
            if (id === activeId) {
                // 选中时文字变白
                labelEl.setAttribute('fill', '#ffffff');
            } else {
                const baseColor = districtBaseColors[id] || defaultDistrictColor;
                labelEl.setAttribute('fill', getLabelColor(baseColor));
            }
        });
    }

    // 根据背景色深浅决定文字颜色(黑/白)
    function getLabelColor(hex) {
        if(!hex) return '#2c3e50';
        const { r, g, b } = hexToRgb(hex);
        // 计算亮度
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance < 0.6 ? '#ffffff' : '#2c3e50'; // 阈值调整为0.6
    }

    function hexToRgb(hex) {
        let sanitized = hex.replace('#', '');
        if (sanitized.length === 3) {
            sanitized = sanitized.split('').map(c => c + c).join('');
        }
        const num = parseInt(sanitized, 16);
        return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
    }

    function updateSelectedDistrictLabel() {
        const label = document.getElementById('selectedDistrict');
        if (!label) return;
        if (booking.region !== 'Seoul' || !booking.district) {
            label.textContent = currentLang === 'ko' ? '없음' : 'None';
            return;
        }
        label.textContent = getDistrictName(booking.district, currentLang);
    }

    function getDistrictName(id, lang = 'en', uppercase = false) {
        if (!id) return '';
        const entry = districtNames[id] || {};
        const base = entry[lang] || entry.en || id.replace(/_/g, ' ');
        return uppercase ? base.toUpperCase() : base;
    }

    function formatDistrictLabel(raw) {
        // 地图上只显示简写英文字母
        let name = getDistrictName(raw, 'en', true);
        return name.replace('GANGSEO', 'GS').replace('YANGCHEON', 'YC')
                   .replace('YEONGDEUNGPO', 'YDP').replace('GURO', 'GR')
                   .replace('GEUMCHEON', 'GC').replace('MAPO', 'MP')
                   .replace('EUNPYEONG', 'EP').replace('SEODAEMUN', 'SDM')
                   .replace('JONGNO', 'JN').replace('JUNG-GU', 'JG')
                   .replace('YONGSAN', 'YS').replace('SEONGDONG', 'SD')
                   .replace('GWANGJIN', 'GJ').replace('DONGDAEMUN', 'DDM')
                   .replace('SEONGBUK', 'SB').replace('GANGBUK', 'GB')
                   .replace('DOBONG', 'DB').replace('NOWON', 'NW')
                   .replace('JUNGNANG', 'JN').replace('DONGJAK', 'DJ')
                   .replace('SEOCHO', 'SC').replace('GANGNAM', 'GN')
                   .replace('SONGPA', 'SP').replace('GANGDONG', 'GD')
                   .replace('GWANAK', 'GA');
    }

    function updateRegionSummary() {
        const sumRegion = document.getElementById('sumRegion');
        if (!sumRegion) return;
        if (!booking.region) {
            sumRegion.textContent = '-';
            return;
        }
        const key = "city_" + booking.region.toLowerCase();
        const base = txt[currentLang][key] || booking.region;
        const detail = (booking.region === 'Seoul' && booking.district)
            ? ' · ' + getDistrictName(booking.district, currentLang)
            : '';
        sumRegion.textContent = base + detail;
    }

    function renderPTs() {
        const grid = document.getElementById('ptGrid');
        grid.innerHTML = '';
        
        const list = ptDB.filter(p => p.region === booking.region);
        const displayList = list.length ? list : ptDB; 

        displayList.forEach(pt => {
            const gender = currentLang === 'en' ? (pt.gender === 'M'?'Male':'Female') : pt.genderKO;
            
            const card = document.createElement('div');
            card.className = 'pt-card';
            card.innerHTML = `
                <img src="${pt.img}" class="pt-img">
                <div class="pt-name">${pt.name}</div>
                <div class="pt-spec">${pt.spec}</div>
                <div class="pt-gender">${gender}</div>
            `;
            card.onclick = () => {
                booking.pt = pt.name;
                document.getElementById('sumPT').textContent = pt.name;
                switchSection(4);
            };
            grid.appendChild(card);
        });
    }
</script>

</body>
</html>